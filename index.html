<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>AIVIO – Ari</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1220, #060a14);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }

    #ari {
      width: 280px;
      border-radius: 18px;
      cursor: pointer;
      box-shadow: 0 0 50px rgba(0,140,255,.35);
      transition: transform .15s ease;
    }

    #ari:active {
      transform: scale(0.97);
    }

    #state {
      margin-top: 20px;
      font-size: 14px;
      opacity: 0.75;
    }
  </style>
</head>
<body>

<h1>Ari</h1>
<p>Kattints rám, beszélj – azonnal válaszolok.</p>

<img id="ari" src="ari.png" alt="Ari" />

<div id="state">Állapot: várakozás</div>

<script>
const VOICE_ID = "7B7mSWflzRSaO1yGeJH6"; // Ari
const STATE = document.getElementById("state");

let recorder;
let chunks = [];
let listening = false;

function setState(t) {
  STATE.innerText = "Állapot: " + t;
}

// --------------------
// SPEAK
// --------------------
function speak(text) {
  setState("beszél");

  const audio = new Audio(
    `/speak?voiceId=${VOICE_ID}&text=${encodeURIComponent(text)}`
  );

  audio.play();

  audio.onended = () => {
    startListening();
  };
}

// --------------------
// LISTEN → THINK → SPEAK
// --------------------
async function startListening() {
  if (listening) return;
  listening = true;

  setState("hallgat");

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  recorder = new MediaRecorder(stream);
  chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = async () => {
    listening = false;
    setState("gondolkodik");

    const blob = new Blob(chunks, { type: "audio/webm" });
    const form = new FormData();
    form.append("audio", blob);

    // 1️⃣ STT
    const sttRes = await fetch("/listen", {
      method: "POST",
      body: form
    }).then(r => r.json());

    if (!sttRes.text || sttRes.text.trim().length < 2) {
      return startListening();
    }

    // 2️⃣ THINK (EZ A LÉNYEG)
    const thinkRes = await fetch("/think", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: sttRes.text,
        robot: "support_inbound"
      })
    }).then(r => r.json());

    if (!thinkRes.text) {
      speak("Ezt most nem teljesen értettem. Megpróbálnád újra?");
      return;
    }

    // 3️⃣ SPEAK – CSAK A GPT VÁLASZA
    speak(thinkRes.text);
  };

  recorder.start();

  // ideiglenes: 5 mp beszédablak
  setTimeout(() => {
    if (recorder.state === "recording") recorder.stop();
  }, 5000);
}

// --------------------
// START (user gesture)
// --------------------
document.getElementById("ari").onclick = () => {
  speak(
    "Szia! Ari vagyok, az ügyfélszolgálati asszisztensed. Mondd el röviden, miben segíthetek."
  );
};
</script>

</body>
</html>
