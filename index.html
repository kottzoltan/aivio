<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>AIVIO – Ari</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      background: #0b1220;
      color: white;
      font-family: system-ui, -apple-system;
      text-align: center;
      padding: 40px;
    }

    #ari {
      width: 260px;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: 0 0 40px rgba(0,150,255,.4);
      transition: transform .2s;
    }

    #ari:active {
      transform: scale(0.97);
    }

    #state {
      margin-top: 20px;
      opacity: 0.8;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h1>Ari</h1>
<p>Kattints rám és beszélj.</p>

<img id="ari" src="ari.png" alt="Ari" />

<div id="state">Állapot: várakozás</div>

<script>
let mediaRecorder;
let audioChunks = [];
let isListening = false;

const STATE = document.getElementById("state");
const VOICE_ID = "7B7mSWflzRSaO1yGeJH6"; // Ari hang

function setState(text) {
  STATE.innerText = "Állapot: " + text;
}

// --------- LISTEN (Whisper)
async function startListening() {
  if (isListening) return;
  isListening = true;

  setState("hallgat");

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    isListening = false;
    setState("gondolkodik");

    const blob = new Blob(audioChunks, { type: "audio/webm" });
    const form = new FormData();
    form.append("audio", blob);

    // STT
    const stt = await fetch("/listen", {
      method: "POST",
      body: form
    }).then(r => r.json());

    if (!stt.text) {
      setState("nem értette, újra hallgat");
      return startListening();
    }

    // THINK
    const think = await fetch("/think", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        text: stt.text,
        robot: "outbound_sales"
      })
    }).then(r => r.json());

    if (!think.text) {
      setState("nem tud válaszolni");
      return;
    }

    // SPEAK
    speak(think.text);
  };

  mediaRecorder.start();

  // 5 mp beszédablak (később VAD-ra cserélhető)
  setTimeout(() => {
    if (mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
  }, 5000);
}

// --------- SPEAK (ElevenLabs)
function speak(text) {
  setState("beszél");

  const audio = new Audio();
  audio.src = `/speak?voiceId=${VOICE_ID}&text=${encodeURIComponent(text)}`;
  audio.play();

  audio.onended = () => {
    setState("válaszolt, újra hallgat");
    startListening();
  };
}

// --------- START (user gesture!)
document.getElementById("ari").onclick = () => {
  speak("Szia, Ari vagyok. Mondj pár szót, és azonnal reagálok.");
};
</script>

</body>
</html>
