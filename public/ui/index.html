<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>AIVIO â€“ AI Ã¼gynÃ¶k demÃ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0f1b33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:#ffffff;
      --muted:rgba(255,255,255,.7);
      --accent:#3b82f6;
      --accent2:#2563eb;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --border:rgba(255,255,255,.10);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a2744 0%, var(--bg1) 35%, var(--bg2) 100%);
      color:var(--text);
    }

    .container{
      max-width:1200px;
      margin:38px auto;
      padding:0 20px 60px;
    }

    header{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:22px;
    }

    h1{
      margin:0;
      font-size:42px;
      letter-spacing:.3px;
    }

    .subtitle{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      max-width:860px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:8px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:13px;
    }

    .pill strong{color:#fff; font-weight:600}

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    button{
      border:none;
      border-radius:14px;
      padding:12px 16px;
      font-size:15px;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      transition:transform .05s ease, background .12s ease;
    }
    button:hover{background:var(--accent2)}
    button:active{transform:scale(.98)}
    button.secondary{
      background:rgba(255,255,255,.10);
      border:1px solid var(--border);
    }
    button.secondary:hover{background:rgba(255,255,255,.14)}
    button.danger{
      background:rgba(239,68,68,.9);
    }
    button.danger:hover{background:rgba(239,68,68,1)}
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(220px, 1fr));
      gap:18px;
      margin-top:18px;
      margin-bottom:26px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:repeat(2, minmax(220px, 1fr));}
    }
    @media (max-width: 540px){
      .grid{grid-template-columns:1fr;}
      h1{font-size:34px;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 40px rgba(0,0,0,.28);
      cursor:pointer;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
      position:relative;
    }
    .card:hover{
      transform:translateY(-2px);
      background:var(--card2);
      border-color:rgba(147,197,253,.35);
    }
    .card.active{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 20px 52px rgba(59,130,246,.10), 0 18px 40px rgba(0,0,0,.28);
    }
    .card img{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
      background:rgba(255,255,255,.04);
    }
    .card .content{
      padding:14px 14px 16px;
    }
    .card .title{
      margin:0 0 6px 0;
      font-size:17px;
      font-weight:700;
    }
    .card .desc{
      margin:0;
      color:var(--muted);
      font-size:13.5px;
      line-height:1.35;
    }
    .badge{
      position:absolute;
      top:12px;
      left:12px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }

    .panel{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .panel{grid-template-columns:1fr;}
    }

    .chat{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      min-height:180px;
    }
    .chat h2{
      margin:0 0 10px 0;
      font-size:16px;
      color:rgba(255,255,255,.9);
    }
    #conversation{
      padding:10px 10px 2px;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      min-height:120px;
      max-height:320px;
      overflow:auto;
    }
    .line{
      margin:0 0 10px 0;
      line-height:1.35;
      font-size:14px;
    }
    .who{
      font-weight:700;
      color:#93c5fd;
    }
    .who.me{color:#a7f3d0}
    .meta{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:13px;
    }

    .side{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
    }
    .side h2{
      margin:0 0 10px 0;
      font-size:16px;
    }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 10px;
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }
    .kv div:nth-child(odd){color:rgba(255,255,255,.85)}
    .note{
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
      border-top:1px solid rgba(255,255,255,.08);
      padding-top:12px;
      margin-top:10px;
    }

    .statusDot{
      width:10px;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.35);
      display:inline-block;
      box-shadow:0 0 0 3px rgba(255,255,255,.06);
    }
    .dotIdle{background:rgba(255,255,255,.35)}
    .dotListening{background:var(--warn)}
    .dotSpeaking{background:var(--accent)}
    .dotReady{background:var(--ok)}
    .dotError{background:var(--err)}

    .small{
      font-size:12px;
      color:rgba(255,255,255,.6);
    }

    input[type="text"]{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:#fff;
      padding:12px 12px;
      outline:none;
      margin-top:10px;
    }
    input[type="text"]::placeholder{color:rgba(255,255,255,.45)}

    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <h1>AIVIO â€“ AI Ã¼gynÃ¶k demÃ³</h1>
      <p class="subtitle">
        VÃ¡lassz egy robotot a kÃ¡rtyÃ¡kra kattintva. A robot bemutatkozik, majd â€majdnem folyamatosanâ€ hallgat:
        amikor befejezted a mondatot, vÃ¡laszol hanggal, Ã©s utÃ¡na automatikusan Ãºjra hallgat.
      </p>

      <div class="topbar">
        <div class="pill">
          <span class="statusDot dotIdle" id="statusDot"></span>
          <span id="statusText">KÃ©szen Ã¡ll</span>
          <span class="small">â€¢ aktÃ­v robot: <strong id="activeAgentName">nincs</strong></span>
        </div>

        <div class="btns">
          <button class="secondary" onclick="testSound()">ğŸ”Š Hang teszt</button>
          <button onclick="startAuto()">ğŸ§ IndÃ­tÃ¡s (auto hallgatÃ¡s)</button>
          <button class="danger" onclick="stopAll()">â›” Stop</button>
        </div>
      </div>
    </header>

    <div class="grid" id="cards">
      <div class="card" data-agent="adel">
        <div class="badge">AdÃ©l</div>
        <img src="/img/outbound-phone.jpg" alt="KimenÅ‘ telefonos sales" />
        <div class="content">
          <div class="title">KimenÅ‘ telefonos sales</div>
          <p class="desc">Telefonos Ã©rtÃ©kesÃ­tÃ©s</p>
        </div>
      </div>

      <div class="card" data-agent="ricsi">
        <div class="badge">Ricsi</div>
        <img src="/img/outbound-email.jpg" alt="Email sales" />
        <div class="content">
          <div class="title">Email sales</div>
          <p class="desc">Email kampÃ¡nyok</p>
        </div>
      </div>

      <div class="card" data-agent="ari">
        <div class="badge">Ari</div>
        <img src="/img/inbound-support.jpg" alt="BejÃ¶vÅ‘ Ã¼gyfÃ©lszolgÃ¡lat" />
        <div class="content">
          <div class="title">BejÃ¶vÅ‘ Ã¼gyfÃ©lszolgÃ¡lat</div>
          <p class="desc">Telefonos tÃ¡mogatÃ¡s</p>
        </div>
      </div>

      <div class="card" data-agent="mihaly">
        <div class="badge">MihÃ¡ly</div>
        <img src="/img/data-collection.jpg" alt="AdatbekÃ©rÅ‘ robot" />
        <div class="content">
          <div class="title">AdatbekÃ©rÅ‘ robot</div>
          <p class="desc">VisszahÃ­vÃ¡ssal</p>
        </div>
      </div>
    </div>

    <div class="panel">
      <section class="chat">
        <h2>BeszÃ©lgetÃ©s</h2>
        <div id="conversation"></div>

        <input id="textInput" type="text" placeholder="Ha nem akarsz beszÃ©lni: Ã­rj ide, majd Enterâ€¦" />

        <div class="row">
          <button class="secondary" onclick="sendTyped()">ğŸ’¬ KÃ¼ldÃ©s (chat)</button>
          <button onclick="listenOnce()">ğŸ¤ HallgatÃ¡s most</button>
        </div>

        <div class="meta">
          <span>Auto hallgatÃ¡s:</span>
          <strong id="autoState">KI</strong>
          <span class="small">â€¢ Tipp: kattints egy kÃ¡rtyÃ¡ra, majd IndÃ­tÃ¡s</span>
        </div>
      </section>

      <aside class="side">
        <h2>AktÃ­v robot</h2>
        <div class="kv">
          <div>NÃ©v</div><div id="sideName">â€”</div>
          <div>Szerep</div><div id="sideRole">â€”</div>
          <div>StÃ­lus</div><div id="sideStyle">â€”</div>
        </div>

        <div class="note">
          <strong>Mit jelent a â€majdnem folyamatosâ€?</strong><br/>
          A bÃ¶ngÃ©szÅ‘ben a mikrofont Ã©s a hangot nem lehet ugyanÃºgy â€teljes-duplexenâ€ kezelni, mint telefonon.
          Itt Ãºgy csinÃ¡ljuk Ã©letszerÅ±vÃ©, hogy: <em>robot beszÃ©l â†’ befejezi â†’ automatikusan ÃºjraindÃ­tjuk a hallgatÃ¡st</em>.
          Ãgy nem kell minden kÃ¶rben nyomkodni a gombot.
        </div>
      </aside>
    </div>

    <!-- a hang lejÃ¡tszÃ¡st explicit audio elemmel kezeljÃ¼k -->
    <audio id="player" preload="auto"></audio>

  </div>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 0) Ãllapotok + segÃ©dek
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const convo = document.getElementById("conversation");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const activeAgentNameEl = document.getElementById("activeAgentName");
    const autoStateEl = document.getElementById("autoState");

    const sideName = document.getElementById("sideName");
    const sideRole = document.getElementById("sideRole");
    const sideStyle = document.getElementById("sideStyle");

    const player = document.getElementById("player");
    const textInput = document.getElementById("textInput");

    let activeAgent = null;
    let autoMode = false;
    let recognition = null;
    let isSpeaking = false;
    let isListening = false;
    let lastUserText = "";

    const AGENT_INFO = {
      adel: {
        name: "AdÃ©l",
        role: "KimenÅ‘ telefonos sales",
        style: "HatÃ¡rozott, barÃ¡tsÃ¡gos, proaktÃ­v."
      },
      ricsi: {
        name: "Ricsi",
        role: "Email sales",
        style: "StrukturÃ¡lt, precÃ­z, okos."
      },
      ari: {
        name: "Ari",
        role: "BejÃ¶vÅ‘ Ã¼gyfÃ©lszolgÃ¡lat",
        style: "Empatikus, nyugodt, segÃ­tÅ‘kÃ©sz."
      },
      mihaly: {
        name: "MihÃ¡ly",
        role: "AdatbekÃ©rÅ‘ robot",
        style: "TÃ¡rgyilagos, lÃ©nyegre tÃ¶rÅ‘."
      }
    };

    function setStatus(mode, text){
      statusText.textContent = text;
      statusDot.className = "statusDot " + mode;
    }

    function addLine(who, text, isMe=false){
      const div = document.createElement("div");
      div.className = "line";
      const cls = isMe ? "who me" : "who";
      div.innerHTML = `<span class="${cls}">${who}:</span> ${escapeHtml(text)}`;
      convo.appendChild(div);
      convo.scrollTop = convo.scrollHeight;
    }

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function requireAgentSelected(){
      if (!activeAgent) {
        addLine("AIVIO", "ElÅ‘szÃ¶r kattints egy kÃ¡rtyÃ¡ra (AdÃ©l / Ricsi / Ari / MihÃ¡ly).");
        return false;
      }
      return true;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) KÃ¡rtyÃ¡k kattintÃ¡s
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("cards").addEventListener("click", async (e) => {
      const card = e.target.closest(".card");
      if (!card) return;

      const agent = card.getAttribute("data-agent");
      if (!agent) return;

      // UI active Ã¡llapot
      document.querySelectorAll(".card").forEach(c => c.classList.remove("active"));
      card.classList.add("active");

      activeAgent = agent;
      activeAgentNameEl.textContent = AGENT_INFO[agent]?.name || agent;

      sideName.textContent = AGENT_INFO[agent]?.name || "â€”";
      sideRole.textContent = AGENT_INFO[agent]?.role || "â€”";
      sideStyle.textContent = AGENT_INFO[agent]?.style || "â€”";

      addLine("AIVIO", `AktÃ­v robot: ${AGENT_INFO[agent].name}. Bemutatkozomâ€¦`);

      // BemutatkozÃ¡s (AI + hang)
      await speakTextViaAgent(
        `Szia! Ã‰n ${AGENT_INFO[agent].name} vagyok, ${AGENT_INFO[agent].role} asszisztens. Mondj egy rÃ¶vid mondatot, Ã©s vÃ¡laszolok.`
      );

      // Ha auto mÃ³d be van kapcsolva, induljon hallgatni
      if (autoMode) {
        setTimeout(() => {
          if (!isSpeaking) startListening();
        }, 250);
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) Hang teszt (biztos user-interaction)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function testSound(){
      try{
        setStatus("dotSpeaking", "Hang teszt...");
        const blob = await fetchSpeakBlob("Szia! Ha ezt hallod, a hang lejÃ¡tszÃ¡s mÅ±kÃ¶dik.");
        await playBlob(blob);
        setStatus("dotReady", "Hang OK");
      }catch(err){
        console.error(err);
        setStatus("dotError", "Hang hiba");
        addLine("AIVIO", "Hang hiba tÃ¶rtÃ©nt. NÃ©zd a konzolt (F12).");
      }finally{
        if (autoMode && activeAgent && !isSpeaking) {
          setTimeout(() => startListening(), 250);
        }
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3) Auto mÃ³d vezÃ©rlÃ©s
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startAuto(){
      autoMode = true;
      autoStateEl.textContent = "BE";
      addLine("AIVIO", "Auto hallgatÃ¡s BE. Kattints egy kÃ¡rtyÃ¡ra (ha mÃ©g nem), vagy mondj valamit.");
      if (requireAgentSelected()) startListening();
    }

    function stopAll(){
      autoMode = false;
      autoStateEl.textContent = "KI";
      stopListening();
      stopSpeaking();
      setStatus("dotIdle", "LeÃ¡llÃ­tva");
      addLine("AIVIO", "LeÃ¡llÃ­tva.");
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4) Egyszeri hallgatÃ¡s gomb
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function listenOnce(){
      if (!requireAgentSelected()) return;
      autoMode = false;
      autoStateEl.textContent = "KI";
      startListening();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5) Chat (Enter vagy gomb)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    textInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendTyped();
    });

    async function sendTyped(){
      if (!requireAgentSelected()) return;
      const t = (textInput.value || "").trim();
      if (!t) return;
      textInput.value = "";
      addLine("Te", t, true);
      await handleUserText(t);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 6) â€Majdnem folyamatosâ€ hallgatÃ¡s (webkitSpeechRecognition)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startListening(){
      if (isSpeaking) return; // amÃ­g beszÃ©l, ne hallgasson
      if (isListening) return;

      if (!("webkitSpeechRecognition" in window)) {
        addLine("AIVIO", "Ez a bÃ¶ngÃ©szÅ‘ nem tÃ¡mogatja a beszÃ©dfelismerÃ©st (Chrome javasolt).");
        return;
      }

      // Ãšj recognition pÃ©ldÃ¡ny minden kÃ¶rben (stabilabb)
      recognition = new webkitSpeechRecognition();
      recognition.lang = "hu-HU";
      recognition.interimResults = false;
      recognition.continuous = false;

      isListening = true;
      setStatus("dotListening", "Hallgat...");

      recognition.onresult = async (event) => {
        const text = event?.results?.[0]?.[0]?.transcript || "";
        const cleaned = text.trim();
        if (!cleaned) return;

        lastUserText = cleaned;
        addLine("Te", cleaned, true);

        // feldolgozzuk (AI + hang)
        await handleUserText(cleaned);
      };

      recognition.onerror = (e) => {
        // tipikus: no-speech, aborted, not-allowed
        console.warn("Speech error:", e);
      };

      recognition.onend = () => {
        isListening = false;

        // Ha auto mÃ³d Ã©s nem beszÃ©l, indÃ­tsuk Ãºjra egy kis kÃ©sleltetÃ©ssel
        if (autoMode && activeAgent && !isSpeaking) {
          setTimeout(() => startListening(), 300);
        } else {
          if (!isSpeaking) setStatus("dotReady", "KÃ©szen Ã¡ll");
        }
      };

      try{
        recognition.start();
      }catch(err){
        console.warn("Recognition start error:", err);
        isListening = false;
        setStatus("dotError", "HallgatÃ¡s hiba");
      }
    }

    function stopListening(){
      try{
        if (recognition) recognition.abort();
      }catch(_){}
      recognition = null;
      isListening = false;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 7) AI â†’ TTS â†’ lejÃ¡tszÃ¡s (robot vÃ¡lasz)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleUserText(userText){
      if (!activeAgent) return;

      // ha Ã©pp beszÃ©l, ne indÃ­tsunk Ãºj kÃ¶rt
      if (isSpeaking) return;

      setStatus("dotSpeaking", "AIVIO vÃ¡laszol...");
      addLine("AIVIO", "â–¶ï¸ AIVIO vÃ¡laszolâ€¦");

      try{
        const answer = await fetchAIAnswer(userText, activeAgent);

        // cserÃ©ljÃ¼k az utolsÃ³ "â–¶ï¸" sort egy valÃ³di vÃ¡laszra (egyszerÅ±en hozzÃ¡adjuk)
        addLine(AGENT_INFO[activeAgent].name, answer);

        const blob = await fetchSpeakBlob(answer);
        await playBlob(blob);

        setStatus("dotReady", "KÃ©szen Ã¡ll");

      }catch(err){
        console.error(err);
        setStatus("dotError", "Hiba");
        addLine("AIVIO", "Hiba tÃ¶rtÃ©nt. NÃ©zd a konzolt (F12).");
      }finally{
        // auto mÃ³d esetÃ©n Ãºjra hallgat
        if (autoMode && activeAgent) {
          setTimeout(() => startListening(), 250);
        }
      }
    }

    async function fetchAIAnswer(text, agent){
      const r = await fetch("/ai", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ text, agent })
      });

      const data = await r.json().catch(() => ({}));
      return (data.answer || "ElnÃ©zÃ©st, nem tudok most vÃ¡laszolni.").trim();
    }

    async function fetchSpeakBlob(text){
      // MegjegyzÃ©s: a voiceId a BACKENDBEN van fixen beÃ¡llÃ­tva.
      const r = await fetch("/speak", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ text })
      });

      // ha itt HTML jÃ¶nne vissza, azonnal kiderÃ¼l: a blob mÃ©rete gyanÃºs + MIME nem audio
      const blob = await r.blob();
      return blob;
    }

    async function playBlob(blob){
      stopSpeaking(); // elÅ‘zÅ‘ lejÃ¡tszÃ¡s stop

      const url = URL.createObjectURL(blob);
      player.src = url;

      isSpeaking = true;
      setStatus("dotSpeaking", "BeszÃ©l...");

      await player.play().catch((err) => {
        // Ha a bÃ¶ngÃ©szÅ‘ blokkolnÃ¡, itt elkapjuk (Ã¡ltalÃ¡ban akkor, ha nem volt user interaction)
        console.error("Audio play blocked:", err);
        throw err;
      });

      // VÃ¡rjuk a lejÃ¡tszÃ¡s vÃ©gÃ©t
      await new Promise((resolve) => {
        player.onended = () => resolve();
      });

      isSpeaking = false;
      URL.revokeObjectURL(url);
    }

    function stopSpeaking(){
      try{
        player.pause();
        player.currentTime = 0;
      }catch(_){}
      isSpeaking = false;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 8) KÃ©pernyÅ‘ indulÃ¡skor
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    setStatus("dotReady", "KÃ©szen Ã¡ll");
    addLine("AIVIO", "VÃ¡lassz egy robotot a kÃ¡rtyÃ¡kra kattintva. (AdÃ©l / Ricsi / Ari / MihÃ¡ly)");
  </script>
</body>
</html>
