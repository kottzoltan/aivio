<h1>AIVIO CRM</h1>

<button onclick="loadAll()">Frissítés</button>

<table border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Név</th>
      <th>Email</th>
      <th>Telefon</th>
      <th>Státusz</th>
      <th>Akció</th>
    </tr>
  </thead>
  <tbody id="leads"></tbody>
</table>

<script>
let stages = [];

async function loadStages() {
  stages = await fetch("/api/crm/stages").then(r => r.json());
}

async function loadLeads() {
  const leads = await fetch("/api/crm/leads").then(r => r.json());
  const tbody = document.getElementById("leads");
  tbody.innerHTML = "";

  leads.forEach(l => {
    const stageOptions = stages.map(s =>
      `<option value="${s.id}" ${l.stage_id && l.stage_id[0] === s.id ? "selected" : ""}>${s.name}</option>`
    ).join("");

    tbody.innerHTML += `
      <tr>
        <td>${l.name}</td>
        <td>${l.email_from || ""}</td>
        <td>${l.phone || ""}</td>
        <td>
          <select onchange="updateStage(${l.id}, this.value)">
            ${stageOptions}
          </select>
        </td>
        <td>
          <button onclick="addNote(${l.id})">Megjegyzés</button>
        </td>
      </tr>
    `;
  });
}

async function updateStage(leadId, stageId) {
  await fetch("/api/crm/update-stage", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ leadId, stageId })
  });
}

async function addNote(leadId) {
  const message = prompt("Írj megjegyzést:");
  if (!message) return;

  await fetch("/api/crm/add-note", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ leadId, message })
  });

  alert("Megjegyzés mentve");
}

async function loadAll() {
  await loadStages();
  await loadLeads();
}

loadAll();
</script>
